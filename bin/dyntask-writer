#!/usr/bin/env ruby
require 'rubygems'
require 'trollop'
require 'pathname'
require 'dyntask/task_mngr'

VERSION='0.1.0'

options = Trollop::options do
  version "dyntask-writer version #{VERSION}"
  banner <<-EOS
dyntask-writer creates a dynamic task file.
Usage:
   dyntask-writer '<dyntask file>' ['<dyntask file2>' ...]
Options:
EOS

end

Trollop::die Trollop::educate if(ARGV.size == 0)
task_mngr=DynTask::TaskMngr.new
task_basename=Pathname.new(ARGV[0]).expand_path.to_s
ARGV[1..-1].each do |task|
	filename,cmd,*opts=task.split(",")
	options=nil
	if opts.empty?
		options={:default => ""}
	elsif opts.length==1 and !opts[0].include? "="
		options={:default => opts[0]}
	else
		options={}
		opts.each{|o|
			key,value=o.split("=")
			options[key.to_sym]=Object.class_eval(value)
		}
	end
	filename=Pathname.new(filename).expand_path.to_s unless filename =~ /^\%/
	p [:added,filename,cmd.to_sym,options]
	task_mngr.add_task(filename,cmd.to_sym,options)
end
 
task_mngr.save_tasks(task_basename)